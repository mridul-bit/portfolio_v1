apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: unified-app-secrets
  namespace: default
spec:
  provider: aws
  
  # 1. Define the actual secrets/parameters to fetch from AWS
  parameters:
    objects: |
      [
        # Sensitive Data from Secrets Manager (JSON format)
        {"objectName": "portfolio-v1-rds-creds", "jmesPath": "DB_USERNAME", "objectType": "secretsmanager"},
        {"objectName": "portfolio-v1-rds-creds", "jmesPath": "DB_PASSWORD", "objectType": "secretsmanager"},
        
        # Non-Sensitive Data from Parameter Store (Standard/String)
        {"objectName": "/portfolio/v1/RESUME_S3_KEY", "objectType": "ssmparameter"},
        {"objectName": "/portfolio/v1/RESUME_BUCKET_NAME", "objectType": "ssmparameter"}
      ]

  # 2. Define the Kubernetes Secret to auto-sync the fetched values into (for ENV vars)
  secretObjects:
    - secretName: app-runtime-config # The K8s Secret name
      type: Opaque
      data:
        # DB Credentials (Sensitive)
        - key: DB_USERNAME
          objectName: portfolio-v1-rds-creds
          jmesPath: "DB_USERNAME"
        - key: DB_PASSWORD
          objectName: portfolio-v1-rds-creds
          jmesPath: "DB_PASSWORD"
        # App Configuration (Non-Sensitive)
        - key: RESUME_S3_KEY
          objectName: /portfolio/v1/RESUME_S3_KEY # Uses the full SSM Parameter path
        - key: RESUME_BUCKET_NAME
          objectName: /portfolio/v1/RESUME_BUCKET_NAME


# apiVersion: secrets-store.csi.x-k8s.io/v1
# kind: SecretProviderClass
# metadata:
#   name: rds-secret-provider
# spec:
#   provider: aws
#   secretObjects:
#     # 1. CRITICAL: This block tells the CSI driver to sync the fetched secrets 
#     # into a native K8s Secret named 'rds-secrets-sync'.
#     - secretName: rds-secrets-sync 
#       type: Opaque
#       data:
#         # Define which secret key maps to which K8s secret key
#         - key: DB_USERNAME
#           objectName: portfolio-v1-rds-creds
#           jmesPath: "DB_USERNAME" # Use JMESPath to extract the value from the JSON secret
#         - key: DB_PASSWORD
#           objectName: portfolio-v1-rds-creds
#           jmesPath: "DB_PASSWORD"
#         - key: DJANGO_SECRET_KEY
#           objectName: portfolio-v1-rds-creds
#           jmesPath: "DJANGO_SECRET_KEY"
          
#   parameters:
#     objects: |
#       [
#         {"objectName": "portfolio-v1-rds-creds", "jmesPath": "DB_USERNAME"},
#         {"objectName": "portfolio-v1-rds-creds", "jmesPath": "DB_PASSWORD"},
#         {"objectName": "portfolio-v1-rds-creds", "jmesPath": "DJANGO_SECRET_KEY"}
#       ]